rules_version = '2';
service cloud.firestore {
    match /databases/{database}/documents {
        // Auth utility functions
        function isAdmin(projectId) {
            return request.auth.token.role == 'admin' && request.auth.token.project == projectId;
        }
        function isOrga(projectId) {
            return request.auth.token.role == 'orga' && request.auth.token.project == projectId;
        }
        function isConvoiDriver(projectId,convoiId) {
            return request.auth.token.role == 'driver'
                   && request.auth.token.project == projectId
                   && request.auth.token.convoi == convoiId;
        }
        // validation functions

        // convoi
        function isValidConvoi() {
            return request.resource.data.keys().hasOnly(['name', 'etd', 'eta', 'to'])
                   && request.resource.data.name is string
                   && request.resource.data.etd is timestamp
                   && request.resource.data.eta is timestamp
                   && request.resource.data.to is latlng;
        }

        // Requests to Add Orga Users
        match /projects/{projectId}/addOrgaRequest/{requestId} {
            allow get: if isAdmin(projectId);
            allow create: if isAdmin(projectId)
                             && request.resource.data.keys().hasOnly(['name', 'email', 'host'])
                             && request.resource.data.name is string
                             && request.resource.data.email is string;
        }
        // Orga Users
        match /projects/{projectId}/orga/{email} {
            allow read: if isAdmin(projectId) || isOrga(projectId);
            allow delete: if isAdmin(projectId);
        }

        // Convois
        match /projects/{projectId}/convois/{convoiId} {
            allow read: if isAdmin(projectId) || isOrga(projectId) || isConvoiDriver(projectId, convoiId);
            allow create: if isAdmin(projectId) && isValidConvoi();
            allow update: if (isAdmin(projectId) || isOrga(projectId)) && isValidConvoi();
            allow delete: if isAdmin(projectId);
        }

        // Login Requests
        match /loginRequests/{documentId} {
            allow create: if true
                             && request.resource.data.keys().hasOnly(['email', 'host'])
                             && request.resource.data.email is string
                             && request.resource.data.host is string;
            allow get: if true;
        }
    }
}